<!DOCTYPE html>
<html>
<head>
    <title>Pateatentnt Details - Patent Registry - Patent Registry - Patent Registry</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
</head>
<body>
    <header>
        <h1>Patent Registry Blockchain Platform</h1>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/marketplace">Marketplace</a></li>
                <li><a href="/dashboard">My Dashboard</a></li>
                <li><a href="/register">Register Patent</a></li>
                <li id="admin-link" style="display: none;"><a href="/admin/verify">Admin Verification</a></li>
            </ul>
        </nav>
        <div class="wallet-container">
            <div id="wallet-status">
                <span id="wallet-address">Wallet not connected</span>
                <button id="connect-wallet">Connect Wallet</button>
                <button id="disconnect-wallet" style="display: none;">Disconnect</button>
            </div>
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="ip-header">
            <h2>Patent #{{ token_id }}</h2>
            <div class="ip-header-actions">
                <a href="javascript:history.back()" class="btn secondary">Browse</a>
            </div>
                <div class="ip-header-actions">
                <a href="javascript:history.back()" class="btn secondary">Browse</a>
                    </div>
        <div class="ip-header-actions">
                <a href="javascript:history.back()" class="btn secondary">Back</a>
                <a href="/marketplace" class="btn secondary">Browse Marketplace</a>
            </div>
    {% if metadata %}
       </section>

        <section class="ip-details-section">
            <div class="ip-details-container">
                    <div class="ip-metadata">
              {% if metadata %}
         <h3>Patent Information</h3>
                    <div class="metadata-content">
  No description available.') }}</p>
                            
                            {% if metadata.patent_type %}
                                <p><strong>Patent Type:</strong> {{ metadata.patent_type|title }}</p>
                            {% endif %}
                            
                            {% if metadata.inventor_name %}
                                <p><strong>Inventor:</strong> {{ metadata.inventor_name }}</p>
                            {% endif %}
                            
                            {% if metadata.filing_date %}
                                <p><strong>Filing Date:</strong> {{ metadata.filing_date } }}</p>
                            {% endif %}
                        {% else %}
                            <p><strong>Title:</strong> Patent #{{ token_id }}</p>
                            <p><strong>Description:</strong> No description available.</p>
                        {% endif %}
                            {% endif %}
                            
                            {% if metadata.created_at %}
                              {% if metadata %}
                              <p><strong>Title:</strong> {{ metadata.title|default('Patent #' ~ token_id) } }}</p>
                            {% endif %}
                        {% else %}
                            <p><strong>Title:</strong> Patent #{{ token_id }}</p>
                            <p><strong>Description:</strong> No description available.</p>
                        {% endif %}
                                <p><strong>Description:</strong> {{ metadata.description|default('No description available.') }}</p>
                            
                        {% if ip_details.transactionHash %}
                            <p><strong>Transaction Hash:</strong> 
                                <a href="https://sepolia.etherscan.io/tx/{{ ip_details.transactionHash }}" target="_blank" class="tx-hash">
                                    {{ ip_details.transactionHash[:8] }}...{{ ip_details.transactionHash[-6:] }}
                                </a>
                            </p>
                        {% else %}
                            <p><strong>Status:</strong> <span class="pending">Pending Registration</span></p>
                        {% endif %}
                        
                        <p><strong>For Sale:</strong> {{ 'Yes' if ip_details.forSale else 'No' }}</p>
                        {% if ip_details.forSale %}
                            <p><strong>Sale Price:</strong> {{ ip_details.salePrice }} ETH</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="ip-actions">
                <h3>Actions</h3>
                <div class="action-buttons">
                    {% if ip_details.forSale %}
                        <button id="place-bid-btn" class="btn primary">Place Bid</button>
                    {% endif %}
                    
                    <div id="owner-actions" style="display: none;">
                        {% if not ip_details.transactionHash %}
                            <button id="register-patent-btn" class="btn primary" data-token-id="{{ token_id }}">Register on Blockchain</button>
                        {% endif %}
                        
                        {% if not ip_details.forSale %}
                            <button id="list-for-sale-btn" class="btn">List for Sale</button>
                        {% endif %}
                        
                        {% if ip_details.forSale %}
                            <a href="/view_bids/{{ token_id }}" class="btn">View Bids</a>
                        {% endif %}
                    </div>
                </div>
            </div>
                            {% if metadata.patent_type %}
                                <p><strong>Patent Type:</strong> {{ metadata.patent_type|title }}</p>
                            {% endif %}
                            
                            {% if metadata.inventor_name %}
                                <p><strong>Inventor:</strong> {{ metadata.inventor_name }}</p>
                            {% endif %}
                            
                            {% if metadata.filing_date %}
                                <p><strong>Filing Date:</strong> {{ metadata.filing_date }}</p>
                            {% endif %}
                            
                            {% if metadata.created_at %}
                                <p><strong>Created:</strong> {{ metadata.created_at }}</p>
                            {% endif %}
                        {% else %}
                            <p><strong>Title:</strong> Patent #{{ token_id }}</p>
                            <p><strong>Description:</strong> No description available.</p>
                        {% endif %}
                    </div>
                </div>
                
                        {% if ip_details.transactionHash %}
                            <p><strong>Transaction Hash:</strong> 
                                <a href="https://sepolia.etherscan.io/tx/{{ ip_details.transactionHash }}" target="_blank" class="tx-hash">
                                    {{ ip_details.transactionHash[:8] }}...{{ ip_details.transactionHash[-6:] }}
            const ownerActions = document.getElementById('owner-actions');
                                </a>
                            </p>
                        {% else %}
                            <p><strong>Status:</strong> <span class="pending">Pending Registration</span></p>
                        {% endif %}
                        
                        <p><strong>For Sale:</strong> {{ 'Yes' if ip_details.forSale else 'No' }}</p>
                        {% if ip_details.forSale %}
                            <p><strong>Sale Price:</strong> {{ ip_details.salePrice }} ETH</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="ip-actions">
                <h3>Actions</h3>
                <div class="action-buttons">
                    {% if ip_details.forSale %}
                        <button id="place-bid-btn" class="btn primary">Place Bid</button>
            // Sale modal elements
            const saleModal = document.getElementById('sale-modal');
            const saleModalClose = document.querySelector('#sale-modal .close');
            const listForSaleForm = document.getElementById('list-for-sale-form');
            const listForSaleBtn = document.getElementById('list-for-sale-btn');
            
            // Register patent button
            const registerPatentBtn = document.getElementById('register-patent-btn');
            
            if (placeBidBtn) {
                placeBidBtn.addEventListener('click', function() {
                    if (!localStorage.getItem('wallet_address')) {
                        alert('Please connect your wallet first');
                        return;
                    }
                    
                    bidModal.style.display = 'block';
                });
            }
            
            if (listForSaleBtn) {
                listForSaleBtn.addEventListener('click', function() {
                    saleModal.style.display = 'block';
                });
            }
            
            if (registerPatentBtn) {
                registerPatentBtn.addEventListener('click', function() {
                    const tokenId = this.getAttribute('data-token-id');
                    
                    if (confirm('Are you sure you want to register this patent on the blockchain? This action cannot be undone.')) {
                        fetch('/register_patent', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                'token_id': tokenId
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.message);
                                window.location.reload();
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while processing your request');
                        });
                    }
                });
            }
            
            // Close bid modal
            if (bidModalClose) {
                bidModalClose.addEventListener('click', function() {
                    bidModal.style.display = 'none';
                });
            }
            
            // Close sale modal
            if (saleModalClose) {
                saleModalClose.addEventListener('click', function() {
                    saleModal.style.display = 'none';
                });
            }
            
            // Close modals        {% endif %}
                    
                    <div id="owner-actions" style="display: none;">
                        {% if not ip_details.transactionHash %}
                                if (event.target == saleModal) {
                    saleModal.style.display = 'none';
                }
            <button id="register-patent-btn" class="btn primary" data-token-id="{{ token_id }}">Register on Blockchain</button>
                        {% endif %}
                        
                        {% if not ip_details.forSale %}
                            <button id="list-for-sale-btn" class="btn">List for Sale</button>
                        {% endif %}
                        
                        {% if ip_details.forSale %}
                            <a href="/view_bids/{{ token_id }}" class="btn">View Bids</a>
                        {% endif %}
                    </div>
                </div>
            </div>
                <div class="ip-blockchain-info">
                    <h3>Blockchain Information</h3>
                    <div class="blockchain-content">
                        <p><strong>Owner:</strong> {{ ip_details.owner|default(ip_details.originalCreator) }}</p>
                        <p><strong>Original Creator:</strong> {{ ip_details.originalCreator }}</p>
                        <p><strong>Expiry Date:</strong> {{ ip_details.expiryTime|timestamp_to_date }}</p>
                        
                        
                        // Check if user is the owner of this patent
                        const originalCreator = "{{ ip_details.originalCreator }}".toLowerCase();
                        if (savedWallet.toLowerCase() === originalCreator) {
                            ownerActions.style.display = 'block';
                        }
                        {% if ip_details.transactionHash %}
                            <p><strong>Transaction Hash:</strong> 
                                <a href="https://sepolia.etherscan.io/tx/{{ ip_details.transactionHash }}" target="_blank" class="tx-hash">
                                    {{ ip_details.transactionHash[:8] }}...{{ ip_details.transactionHash[-6:] }}
                                </a>
                            </p>
                        {% else %}
                            <p><strong>Status:</strong> <span class="pending">Pending Registration</span></p>
                        {% endif %}
                        
                        <p><strong>For Sale:</strong> {{ 'Yes' if ip_details.forSale else 'No' }}</p>
                        {% if ip_details.forSale %}
                            <p><strong>Sale Price:</strong> {{ ip_details.salePrice }} ETH</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="ip-actions">
            const ownerActions = document.getElementById('owner-actions');
                <h3>Actions</h3>
                <div class="action-buttons">
                    {% if ip_details.forSale %}
                        <button id="place-bid-btn" class="btn primary">Place Bid</button>
                    {% endif %}
                    
                    <div id="owner-actions" style="display: none;">
                        {% if not ip_details.transactionHash %}
                            <button id="register-patent-btn" class="btn primary" data-token-id="{{ token_id }}">Register on Blockchain</button>
                        {% endif %}
                        
                                
                                // Check if user is the owner of this patent
                                const originalCreator = "{{ ip_details.originalCreator }}".toLowerCase();
                                if (account.toLowerCase() === originalCreator) {
                                    ownerActions.style.display = 'block';
                                }
                        {% if not ip_details.forSale %}
                            <button id="list-for-sale-btn" class="btn">List for Sale</button>
                        {% endif %}
                        
                        {% if ip_details.forSale %}
                            <a href="/view_bids/{{ token_id }}" class="btn">View Bids</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Modal for placing a bid -->
        <div id="bid-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>Place a Bid</h3>
                <form id="place-bid-form">
                    <input type="hidden" id="token-id-input" name="token_id" value="{{ token_id }}">
                    <div class="form-group">
                        <label for="bid-amount-input">Bid Amount (ETH):</label>
                        ownerActions.style.display = 'none';
                        <input type="number" id="bid-amount-input" name="bid_amount" step="0.01" min="{{ ip_details.salePrice }}" required>
    // Sale modal elements
            const saleModal = document.getElementById('sale-modal');
            const saleModalClose = document.querySelector('#sale-modal .close');
            const listForSaleForm = document.getElementById('list-for-sale-form');
            const listForSaleBtn = document.getElementById('list-for-sale-btn');
            
            // Register patent button
            const registerPatentBtn = document.getElementById('register-patent-btn');
            
            if (placeBidBtn) {
                placeBidBtn.addEventListener('click', function() {
                    if (!localStorage.getItem('wallet_address')) {
                        alert('Please connect your wallet first');
                        return;
                    }
                    
                    bidModal.style.display = 'block';
                });
            }
            
            if (listForSaleBtn) {
                listForSaleBtn.addEventListener('click', function() {
                    saleModal.style.display = 'block';
                });
            }
            
            if (registerPatentBtn) {
                registerPatentBtn.addEventListener('click', function() {
                    const tokenId = this.getAttribute('data-token-id');
                    
                    if (confirm('Are you sure you want to register this patent on the blockchain? This action cannot be undone.')) {
                        fetch('/register_patent', {
                            method: 'POST',
                        
            // List for sale form submission
            if (listForSaleForm) {
                listForSaleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!localStorage.getItem('wallet_address')) {
                        alert('Please connect your wallet first');
                        return;
                    }
                    
                    const tokenId = document.getElementById('sale-token-id-input').value;
                    const price = document.getElementById('price-input').value;
                    
                    fetch('/list_for_sale', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'token_id': tokenId,
                            'price': price
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            saleModal.style.display = 'none';
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing your request');
                    });
                });
            }
                headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                'token_id': tokenId
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.message);
                                window.location.reload();
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while processing your request');
                        });
                    }
                });
            }
                if (event.target == saleModal) {
                    saleModal.style.display = 'none';
                }
            
            // Close bid modal
            if (bidModalClose) {
                bidModalClose.addEventListener('click', function() {
                    bidModal.style.display = 'none';
                });
            }
            
            // Close sale modal
            if (saleModalClose) {
                saleModalClose.addEventListener('click', function() {
                    saleModal.style.display = 'none';
                });
            }
            
            // Close modals                    <small>Current price: {{ ip_details.salePrice }} ETH</small>
                    </div>
                    <button type="submit" class="btn primary">Submit Bid</button>
                </form>
            </div>
        </div>
        
        <!-- Modal for listing for sale -->
        <div id="sale-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>List Patent for Sale</h3>
                <form id="list-for-sale-form">
                    <input type="hidden" id="sale-token-id-input" name="token_id" value="{{ token_id }}">
                    <div class="form-group">
                        
                        // Check if user is the owner of this patent
                        const originalCreator = "{{ ip_details.originalCreator }}".toLowerCase();
                        if (savedWallet.toLowerCase() === originalCreator) {
                            ownerActions.style.display = 'block';
                        }
                        <label for="price-input">Sale Price (ETH):</label>
                        <input type="number" id="price-input" name="price" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" class="btn primary">List for Sale</button>
                </form>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2023 Patent Registry Blockchain Platform. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const connectWalletBtn = document.getElementById('connect-wallet');
            const disconnectWalletBtn = document.getElementById('disconnect-wallet');
            const walletAddressSpan = document.getElementById('wallet-address');
            const adminLink = document.getElementById('admin-link');
            const ownerActions = document.getElementById('owner-actions');
            
            // Bid modal elements
            const bidModal = document.getElementById('bid-modal');
            const bidModalClose = document.querySelector('#bid-modal .close');
            const placeBidForm = document.getElementById('place-bid-form');
            const placeBidBtn = document.getElementById('place-bid-btn');
            
            // Sale modal elements
            const saleModal = document.getElementById('sale-modal');
            const saleModalClose = document.querySelector('#sale-modal .close');
            const listForSaleForm = document.getElementById('list-for-sale-form');
            const listForSaleBtn = document.getElementById('list-for-sale-btn');
            
            // Register patent button
            const registerPatentBtn = document.getElementById('register-patent-btn');
            
                                
                                // Check if user is the owner of this patent
                                const originalCreator = "{{ ip_details.originalCreator }}".toLowerCase();
                                if (account.toLowerCase() === originalCreator) {
                                    ownerActions.style.display = 'block';
                                }
            if (placeBidBtn) {
                placeBidBtn.addEventListener('click', function() {
                    if (!localStorage.getItem('wallet_address')) {
                        alert('Please connect your wallet first');
                        return;
                    }
                    
                    bidModal.style.display = 'block';
                });
            }
            
            if (listForSaleBtn) {
                listForSaleBtn.addEventListener('click', function() {
                    saleModal.style.display = 'block';
                });
            }
            
            if (registerPatentBtn) {
                registerPatentBtn.addEventListener('click', function() {
                    const tokenId = this.getAttribute('data-token-id');
                    
                    if (confirm('Are you sure you want to register this patent on the blockchain? This action cannot be undone.')) {
                        ownerActions.style.display = 'none';
                        fetch('/register_patent', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                'token_id': tokenId
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.message);
                                window.location.reload();
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while processing your request');
                        });
                    }
                });
            }
            
            // Close bid modal
            if (bidModalClose) {
                bidModalClose.addEventListener('click', function() {
                    bidModal.style.display = 'none';
                });
            }
            
            // Close sale modal
            if (saleModalClose) {
                saleModalClose.addEventListener('click', function() {
                    saleModal.style.display = 'none';
                });
            }
            
            // List for sale form submission
            if (listForSaleForm) {
                listForSaleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!localStorage.getItem('wallet_address')) {
                        alert('Please connect your wallet first');
                        return;
                    }
                    
                    const tokenId = document.getElementById('sale-token-id-input').value;
                    const price = document.getElementById('price-input').value;
                    
                    fetch('/list_for_sale', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'token_id': tokenId,
                            'price': price
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            saleModal.style.display = 'none';
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing your request');
                    });
                });
            }
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target == bidModal) {
                    bidModal.style.display = 'none';
                }
                if (event.target == saleModal) {
                    saleModal.style.display = 'none';
                }
            });
            
            // Check if wallet is already connected in session
            const savedWallet = localStorage.getItem('wallet_address');
            if (savedWallet) {
                fetch('/connect_wallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'wallet_address': savedWallet
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.wallet) {
                        walletAddressSpan.textContent = `${data.wallet.substring(0, 6)}...${data.wallet.substring(data.wallet.length - 4)}`;
                        connectWalletBtn.style.display = 'none';
                        disconnectWalletBtn.style.display = 'inline-block';
                        
                        if (data.is_admin) {
                            adminLink.style.display = 'inline-block';
                        }
                        
                        // Check if user is the owner of this patent
                        const originalCreator = "{{ ip_details.originalCreator }}".toLowerCase();
                        if (savedWallet.toLowerCase() === originalCreator) {
                            ownerActions.style.display = 'block';
                        }
                    }
                });
            }
            
            // Connect wallet button
            connectWalletBtn.addEventListener('click', async function() {
                if (window.ethereum) {
                    try {
                        // Request account access
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        const account = accounts[0];
                        
                        // Save to session
                        fetch('/connect_wallet', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                'wallet_address': account
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                localStorage.setItem('wallet_address', account);
                                walletAddressSpan.textContent = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
                                connectWalletBtn.style.display = 'none';
                                disconnectWalletBtn.style.display = 'inline-block';
                                
                                if (data.is_admin) {
                                    adminLink.style.display = 'inline-block';
                                }
                                
                                // Check if user is the owner of this patent
                                const originalCreator = "{{ ip_details.originalCreator }}".toLowerCase();
                                if (account.toLowerCase() === originalCreator) {
                                    ownerActions.style.display = 'block';
                                }
                            }
                        });
                    } catch (error) {
                        console.error("User denied account access");
                    }
                } else {
                    alert('Please install MetaMask or another Ethereum wallet provider');
                }
            });
            
            // Disconnect wallet button
            disconnectWalletBtn.addEventListener('click', function() {
                fetch('/disconnect_wallet', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem('wallet_address');
                        walletAddressSpan.textContent = 'Wallet not connected';
                        connectWalletBtn.style.display = 'inline-block';
                        disconnectWalletBtn.style.display = 'none';
                        adminLink.style.display = 'none';
                        ownerActions.style.display = 'none';
                    }
                });
            });
            
            // Place bid form submission
            if (placeBidForm) {
                placeBidForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!localStorage.getItem('wallet_address')) {
                        alert('Please connect your wallet first');
                        return;
                    }
                    
                    const tokenId = document.getElementById('token-id-input').value;
                    const bidAmount = document.getElementById('bid-amount-input').value;
                    
                    fetch('/place_bid', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'token_id': tokenId,
                            'bid_amount': bidAmount
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            bidModal.style.display = 'none';
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing your request');
                    });
                });
            }
            
            // List for sale form submission
            if (listForSaleForm) {
                listForSaleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!localStorage.getItem('wallet_address')) {
                        alert('Please connect your wallet first');
                        return;
                    }
                    
                    const tokenId = document.getElementById('sale-token-id-input').value;
                    const price = document.getElementById('price-input').value;
                    
                    fetch('/list_for_sale', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'token_id': tokenId,
                            'price': price
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            saleModal.style.display = 'none';
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing your request');
                    });
                });
            }
        });
    </script>
</body>
</html>